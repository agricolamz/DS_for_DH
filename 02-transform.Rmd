# `tidyverse`: Загрузка и трансформация данных {#tidy_dplyr}

[_tidyverse_](https://www.tidyverse.org) --- это набор пакетов:

* _ggplot2_, для визуализации
* _tibble_, для работы с тибблами, современный вариант датафрейма
* _tidyr_, для формата tidy data
* _readr_, для чтения файлов в R
* _purrr_, для функционального программирования
* _dplyr_, для преобразованиия данных
* _stringr_, для работы со строковыми переменными
* _forcats_, для работы с переменными-факторами

Полезно также знать о следующих:

* _readxl_, для чтения .xls и .xlsx
* _jsonlite_, для работы с JSON
* _rvest_, для веб-скреппинга
* _lubridate_, для работы с временем
* _tidytext_, для работы с текстами и корпусами
* _broom_, для перевода в tidy формат статистические модели

```{r, message = TRUE}
library(tidyverse)
```

## Загрузка данных
### Рабочая директория

Все в R происходит где-то. Нужно загружать файлы с данными, нужно их куда-то сохранять. Желательно иметь для каждого проекта некоторую отдельную папку на компьютере, куда складывать все, отнсящееся к этому проекту. Две команды позволят опредить текущую рабочую дерикторию (`getwd()`) и (`setwd(.../path/to/your/directory)`).

### Форматы данных: `.csv`

Существет много форматов данных, которые придумали люди. Большинство из них можно загрузить в R. Так как центральный объект в R -- таблица $n \times k$, то и работать мы большую часть времени будем с таблицами. Наиболее распространенные способы хранить данные сейчас это `.csv` (разберем в данном разделе) и `.json` (разберем в разделе @ref{dplyr_purr}).

`.csv` (comma separated values) -- является обычным текстовым файлом, в котором перечислены значения с некоторым фиксированным разделителем: запятой, табуляцией, точка с запятой, пробел и др. Такие файлы обычно легко открывает LibreOffice, а в Microsoft Excel нужны некоторые трюки.

### Загрузка данных: readr, readxl
Стандартной функцией для чтения `.csv` файлов в R является функция `read.csv()`, но мы будем использовать функцию `read_csv()` из пакета `readr`.

```{r, eval = FALSE}
read_csv("...")
```

Вместо многоточия может стоять:

* название файла  (если он, есть в текущей рабочей дериктории)
```{r, eval = FALSE}
read_csv("my_file.csv")
```

* относительный путь к файлу (если он, верен для текущей рабочей дериктории)
```{r, eval = FALSE}
read_csv("data/my_file.csv")
```

* полный путь к файлу (если он, верен для текущей рабочей дериктории)
```{r, eval = FALSE}
read_csv("/home/user_name/work/data/my_file.csv")
```

* интернет ссылка (тогда, компьютер должен быть подключен к интернету)
```{r, eval = FALSE}
read_csv("https://my_host/my_file.csv")
```

Для чтения других форматов `.csv` файлов используются другие функции:

* `read_tsv()` -- для файлов с табуляцией в качестве разделителя
* `read_csv2()` -- для файлов с точкой с запятой в качестве разделителя 
* `read_delim(file = "...", delim = "...")` -- для файлов с любым разделителем, задаваемым аргументом `delim`

Стандартной практикой является создавать первой строкой `.csv` файлов названия столбцов, поэтому по умолчанию функции `read_...()`  будут создавать таблицу, считая первую строку названием столбцов. Чтобы изменить это поведение следует использовать аргумент `col_names = FALSE`.

Другая проблема при чтении файлов -- кодировка и локаль. На разных компьютерах разные локали и дефолтные кодировки, так что имеет смысл знать про аргумент `locale("en_US", encoding = "UTF-8")`.

> Попробуйте корректно считать в R файл [по этой ссылке](https://raw.githubusercontent.com/agricolamz/DS_for_DH/master/data/scary_letters.csv).

```{r, echo=FALSE}
read_csv2("https://raw.githubusercontent.com/agricolamz/DS_for_DH/master/data/scary_letters.csv")
```


#### Misspelling dataset
Этот датасет я переработал из данных, собранных для статьи [The Gyllenhaal Experiment](https://pudding.cool/2019/02/gyllenhaal/), написанной Расселом Гольденбергом и Мэттом Дэниэлсом для издания [pudding](https://pudding.cool). Они анализировали ошибки в правописании при поиске имен и фамилий звезд.

```{r}
misspellings <- read_csv("https://raw.githubusercontent.com/agricolamz/DS_for_DH/master/data/misspelling_dataset.csv")
```
  

```{r}
misspellings
```

В датасете следующие переменные:

* `correct` -- корректное написание фамилии
* `spelling` -- написание, которое сделали пользователи
* `count` -- количество случаев такого написания

## `tibble`

Пакет `tibble` -- является альтернативой штатного датафрейма в R. Существует встроенная переменная `month.name`:

```{r}
month.name
```

Можно создать датафрейм таким образом:

```{r, eval = FALSE}
data.frame(id = 1:12,
           months = month.name,
           n_letters = nchar(months))
```

Однако переменная `months` не создана пользователем, так что данный код выдает ошибку. Корректный способ сделать это базовыми средствами:

```{r}
data.frame(id = 1:12,
           months = month.name,
           n_letters = nchar(month.name))
```

Одно из отличий `tibble` от базового датафрейма -- возможность использовать создаваемые "по ходу пьесы переменные"

```{r}
tibble(id = 1:12,
       months = month.name,
       n_letters = nchar(months))
```

Если в окружении пользователя уже есть переменная с датафреймом, его легко можно переделать в `tibble` при помощи функции `as_tibble()`:

```{r}
df <- data.frame(id = 1:12,
                 months = month.name)

df
as_tibble(df)
```

Функицонально `tibble` от `data.frame` ничем не отличается, однако существует ряд несущественных отличий. Кроме того стоит помнить, что многие функции из `tidyverse` возвращают именно `tibble`, а не `data.frame`.



